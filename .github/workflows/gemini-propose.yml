name: "ðŸ§  Gemini Propose Fix"

on:
  issues:
    types: [opened]

permissions:
  contents: read
  issues: write

concurrency:
  group: "${{ github.workflow }}-issue-${{ github.event.issue.number }}"
  cancel-in-progress: true

jobs:
  propose:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Gemini (propose patch)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          workflow_name: gemini-propose
          gemini_model: ${{ vars.GEMINI_MODEL }}
          gemini_debug: false
          upload_artifacts: true
          settings: |
            {
              "model": { "maxSessionTurns": 30 },
              "telemetry": {
                "enabled": true,
                "target": "local",
                "outfile": ".gemini/telemetry.log"
              },
              "tools": {
                "core": [
                  "run_shell_command(cat)",
                  "run_shell_command(grep)",
                  "run_shell_command(find)",
                  "run_shell_command(head)",
                  "run_shell_command(tail)",
                  "run_shell_command(ls)"
                ]
              }
            }
          prompt: |
            You are working in a Git repo checked out in the current workspace.

            Issue #${{ github.event.issue.number }}
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            Your job:
            1) Identify the minimal change needed.
            2) DO NOT modify any files.
            3) Output TWO sections in plain text:

            SECTION A: SUMMARY
            - 3-7 bullet points: what youâ€™ll change and why.

            SECTION B: PATCH
            - A unified diff that can be applied with `git apply`.
            - Put the diff inside a fenced code block that starts with ```diff and ends with ```.

            If the change is not possible, explain why in SECTION A and omit SECTION B.

      - name: Extract patch from Gemini output
        id: extract
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, re, sys
          text = os.environ.get("GEMINI_OUTPUT", "")
          # Look for a ```diff ... ``` block
          m = re.search(r"```diff\s*(.*?)\s*```", text, re.DOTALL)
          if not m:
            print("No diff block found in Gemini output.")
            sys.exit(0)
          patch = m.group(1).strip() + "\n"
          with open("gemini.patch", "w", encoding="utf-8") as f:
            f.write(patch)
          print(f"Wrote gemini.patch ({len(patch)} bytes)")
          PY
        env:
          GEMINI_OUTPUT: ${{ steps.gemini.outputs.gemini_response }}

      - name: Upload patch artifact (if present)
        uses: actions/upload-artifact@v4
        with:
          name: gemini-patch-issue-${{ github.event.issue.number }}
          path: gemini.patch
          if-no-files-found: warn

      - name: Comment with summary + approval instruction
        uses: actions/github-script@v8
        env:
          OUT: ${{ steps.gemini.outputs.gemini_response }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          script: |
            const out = (process.env.OUT || "").trim();
            const issueNumber = Number(process.env.ISSUE_NUMBER);
            const runUrl = process.env.RUN_URL;

            // Pull SECTION A (SUMMARY) if present, otherwise just include the whole output (trimmed)
            let summary = out;
            const m = out.match(/SECTION A: SUMMARY([\s\S]*?)(SECTION B: PATCH|$)/i);
            if (m) summary = m[1].trim();

            const body = [
              "### Gemini proposed a fix",
              "",
              summary ? summary : "(No response.)",
              "",
              `Patch artifact: **gemini-patch-issue-${issueNumber}**`,
              `Workflow run: ${runUrl}`,
              "",
              "**To apply this patch and open a PR:** comment `@gemini-cli /apply`."
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });

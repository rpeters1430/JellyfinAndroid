name: 'ðŸ”€ Gemini Dispatch'

on:
  pull_request_review_comment:
    types:
      - 'created'
  pull_request_review:
    types:
      - 'submitted'
  pull_request:
    types:
      - 'opened'
  issues:
    types:
      - 'opened'
      - 'reopened'
  issue_comment:
    types:
      - 'created'

defaults:
  run:
    shell: 'bash'

jobs:
  debugger:
    if: |-
      ${{ fromJSON(vars.GEMINI_DEBUG || vars.ACTIONS_STEP_DEBUG || false) }}
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: 'Debug event payload'
        env:
          EVENT_JSON: ${{ toJSON(github.event) }}
        run: |
          echo "$EVENT_JSON" | jq .

  dispatch:
    if: |
      (
        github.event_name == 'pull_request' &&
        github.event.pull_request.head.repo.fork == false
      ) || (
        github.event_name == 'issues' &&
        contains(fromJSON('["opened", "reopened"]'), github.event.action)
      ) || (
        github.event.sender.type == 'User' &&
        startsWith(github.event.comment.body || github.event.review.body || github.event.issue.body, '@gemini-cli') &&
        !contains(github.event.comment.body || github.event.review.body || github.event.issue.body, '/fix') &&
        !contains(github.event.comment.body || github.event.review.body || github.event.issue.body, '/approve') &&
        !contains(github.event.comment.body || github.event.review.body || github.event.issue.body, '/deny') &&
        contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association || github.event.review.author_association || github.event.issue.author_association)
      )
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      invocation_id: ${{ steps.dispatch.outputs.invocation_id }}
      invocation_type: ${{ steps.dispatch.outputs.invocation_type }}
    steps:
      - name: 'Dispatch invocation'
        id: 'dispatch'
        env:
          EVENT_JSON: ${{ toJSON(github.event) }}
        run: |
          set -euo pipefail

          EVENT_NAME="${GITHUB_EVENT_NAME}"
          ACTION="${{ github.event.action || '' }}"

          # Determine whether we're operating on a PR or Issue context
          ISSUE_NUMBER="${{ github.event.issue.number || '' }}"
          PR_NUMBER="${{ github.event.pull_request.number || '' }}"

          # A unique id for the "invocation"
          INVOCATION_ID="$(date +%s)-${GITHUB_RUN_ID}"
          INVOCATION_TYPE="unknown"

          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            INVOCATION_TYPE="pull_request_opened"
          elif [[ "$EVENT_NAME" == "issues" ]]; then
            INVOCATION_TYPE="issue_opened"
          elif [[ "$EVENT_NAME" == "issue_comment" ]]; then
            INVOCATION_TYPE="issue_comment"
          elif [[ "$EVENT_NAME" == "pull_request_review" ]]; then
            INVOCATION_TYPE="pull_request_review"
          elif [[ "$EVENT_NAME" == "pull_request_review_comment" ]]; then
            INVOCATION_TYPE="pull_request_review_comment"
          fi

          echo "invocation_id=$INVOCATION_ID" >> "$GITHUB_OUTPUT"
          echo "invocation_type=$INVOCATION_TYPE" >> "$GITHUB_OUTPUT"

          echo "Dispatch: $INVOCATION_TYPE ($INVOCATION_ID)"

  review:
    if: |-
      ${{
        needs.dispatch.outputs.invocation_type == 'pull_request_review' ||
        needs.dispatch.outputs.invocation_type == 'pull_request_review_comment'
      }}
    needs: [dispatch]
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: 'Invoke Gemini Review'
        uses: actions/github-script@v7
        with:
          script: |
            core.info('Review event routed to gemini-review.yml (or invoke job).')

  triage:
    if: |-
      ${{
        needs.dispatch.outputs.invocation_type == 'issue_opened'
      }}
    needs: [dispatch]
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: 'Invoke Gemini Triage'
        uses: actions/github-script@v7
        with:
          script: |
            core.info('Issue opened event routed to gemini-triage.yml (or invoke job).')

  invoke:
    if: |-
      ${{
        needs.dispatch.outputs.invocation_type != ''
      }}
    needs: [dispatch]
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: 'Invoke Gemini CLI (generic)'
        uses: actions/github-script@v7
        with:
          script: |
            core.info('Generic invoke flow runs in gemini-invoke.yml.')

  fallthrough:
    if: |-
      ${{
        needs.dispatch.outputs.invocation_type == ''
      }}
    needs: [dispatch]
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'No matching route'
        run: |
          echo "No dispatch route matched."

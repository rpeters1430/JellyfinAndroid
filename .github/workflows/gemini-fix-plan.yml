# üìã Gemini Fix Plan Workflow
#
# Triggered by: Comment "/fix" on an issue
# Creates a detailed plan for fixing the issue with implementation steps.
# Adds "gemini:awaiting-approval" label and waits for /approve.
#
# Documentation: .github/GEMINI_WORKFLOWS.md

name: Gemini Fix Plan (Issue)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

concurrency:
  group: gemini-fix-plan-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  plan:
    if: |
      github.event.issue.pull_request == null &&
      (startsWith(github.event.comment.body, '/fix') || startsWith(github.event.comment.body, '@gemini-cli /fix'))
    runs-on: ubuntu-latest

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Run Gemini (create plan + questions)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          workflow_name: gemini-fix-plan
          upload_artifacts: true
          prompt: |
            You are a GitHub issue assistant analyzing an issue to create a fix plan.

            Create a concise, actionable plan to fix the issue below.
            Be specific about what files need to be changed and what the changes should accomplish.
            Only ask clarifying questions if the issue is genuinely ambiguous.

            **Output Format:**

            ## üìã Fix Plan
            1. [First step with specific file/action]
            2. [Second step with specific file/action]
            3. [etc.]

            ## ‚ùì Questions (if any)
            - [Only include if truly necessary]

            ## ‚öôÔ∏è Implementation Approach
            [Brief technical approach or considerations]

            ---
            ## üöÄ Next Steps
            - Comment `/approve` to implement this fix and create a PR
            - Comment `/deny` to take no action

            **Issue Title:** ${{ github.event.issue.title }}

            **Issue Body:**
            ${{ github.event.issue.body }}

      - name: Add awaiting-approval label
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const label = 'gemini:awaiting-approval';

            await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [label] });

      - name: Post plan to issue
        uses: actions/github-script@v7
        env:
          GEMINI_SUMMARY: ${{ steps.gemini.outputs.summary }}
          GEMINI_ERROR: ${{ steps.gemini.outputs.error }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const summary = (process.env.GEMINI_SUMMARY || '').trim();
            const err = (process.env.GEMINI_ERROR || '').trim();

            let body = `## ü§ñ Gemini plan\n\n`;
            body += summary ? summary : '_No output received from Gemini._';
            if (err) body += `\n\n---\n### ‚ö†Ô∏è Error\n\`\`\`\n${err}\n\`\`\``;

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

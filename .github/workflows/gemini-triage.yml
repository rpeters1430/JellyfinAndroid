name: "üè∑Ô∏è Gemini Triage (Label Issues)"

on:
  issues:
    types: [opened, reopened]

permissions:
  issues: write
  contents: read

concurrency:
  group: gemini-triage-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  triage:
    runs-on: ubuntu-latest
    timeout-minutes: 7

    steps:
      - name: Run Gemini (produce labels JSON)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          workflow_name: gemini-triage
          upload_artifacts: false
          prompt: |
            You are an issue triage assistant.
            Output ONLY valid JSON with schema:

            {"labels":["type:bug","area:docs","priority:medium"]}

            Allowed families (prefer):
            - type:bug | type:feature | type:chore | type:question
            - area:android | area:ui | area:backend | area:build | area:docs
            - priority:low | priority:medium | priority:high

            Output ONLY JSON (no markdown).

            Issue title: ${{ github.event.issue.title }}

            Issue body:
            ${{ github.event.issue.body }}

      - name: Apply labels
        uses: actions/github-script@v7
        env:
          GEMINI_JSON: ${{ steps.gemini.outputs.summary }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const raw = (process.env.GEMINI_JSON || '').trim();
            if (!raw) {
              core.warning('Empty Gemini output; skipping labels.');
              return;
            }

            let data;
            try { data = JSON.parse(raw); }
            catch (e) {
              core.warning('Gemini output not valid JSON:\n' + raw);
              return;
            }

            const labels = Array.isArray(data.labels) ? data.labels.filter(Boolean) : [];
            if (!labels.length) {
              core.info('No labels suggested.');
              return;
            }

            // Best effort: create missing labels
            for (const name of labels) {
              try {
                await github.rest.issues.createLabel({
                  owner, repo, name,
                  color: 'ededed',
                  description: 'Auto-added by Gemini triage'
                });
              } catch (e) {}
            }

            await github.rest.issues.addLabels({ owner, repo, issue_number, labels });
            core.info(`Applied labels: ${labels.join(', ')}`);

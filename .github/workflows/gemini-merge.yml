# âœ… Gemini Merge PR Workflow
#
# Triggered by: Comment "/approve" on a PR with gemini:awaiting-merge label
# Squash merges the PR and comments on both the PR and original issue.
# This is the final step in the automated fix workflow.
#
# Documentation: .github/GEMINI_WORKFLOWS.md

name: Gemini Merge PR (Approve)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-merge-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  merge:
    if: |
      github.event.issue.pull_request != null &&
      (github.event.comment.body == '/approve' || github.event.comment.body == '@gemini-cli /approve')
    runs-on: ubuntu-latest

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Verify PR has awaiting-merge label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            if (!labels.includes('gemini:awaiting-merge')) {
              core.setFailed('PR is not in gemini:awaiting-merge state.');
            }

      - name: Merge PR (squash)
        id: merge
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.issue.number;

            const result = await github.rest.pulls.merge({
              owner, repo,
              pull_number,
              merge_method: 'squash',
              commit_title: `Fix: #${pull_number} (Gemini) (#${pull_number})`,
              commit_message: `Merged PR #${pull_number} - Automated fix by Gemini`
            });
            
            core.setOutput('merged', result.data.merged);
            core.setOutput('sha', result.data.sha);

      - name: Clean up labels + comment
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Remove the awaiting-merge label
            for (const name of ['gemini:awaiting-merge']) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name });
              } catch (e) {}
            }

            // Comment on the PR
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `ðŸš€ **Merged!** Changes have been integrated into the main branch.`
            });
            
            // Try to extract the original issue number from the PR body
            // PR body format: "Closes #123\n\nComment `/approve` ..."
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: issue_number });
            const prBody = pr.data.body || '';
            const issueMatch = prBody.match(/Closes #(\d+)/i);
            
            if (issueMatch) {
              const originalIssue = parseInt(issueMatch[1]);
              try {
                await github.rest.issues.createComment({
                  owner, repo,
                  issue_number: originalIssue,
                  body: `âœ… **Fixed!** PR #${issue_number} has been merged and this issue is now resolved.`
                });
              } catch (e) {
                console.log(`Could not comment on issue #${originalIssue}: ${e.message}`);
              }
            }

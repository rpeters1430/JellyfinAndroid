# ‚úÖ Gemini Merge PR Workflow
#
# Triggered by: Comment "/approve" on a PR with gemini:awaiting-merge label
# Squash merges the PR and comments on both the PR and original issue.
# This is the final step in the automated fix workflow.
#
# Documentation: .github/GEMINI_WORKFLOWS.md

name: Gemini Merge PR (Approve)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-merge-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  merge:
    if: |
      github.event.issue.pull_request != null &&
      (startsWith(github.event.comment.body, '/approve') || startsWith(github.event.comment.body, '@gemini-cli /approve'))
    runs-on: ubuntu-latest

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Verify PR has awaiting-merge label
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            if (!labels.includes('gemini:awaiting-merge')) {
              core.setFailed('PR is not in gemini:awaiting-merge state.');
            }

      - name: Merge PR (squash)
        id: merge
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.issue.number;

            try {
              const result = await github.rest.pulls.merge({
                owner, repo,
                pull_number,
                merge_method: 'squash',
                commit_title: `Fix: PR #${pull_number} (Gemini)`,
                commit_message: `Merged PR #${pull_number} - Automated fix by Gemini`
              });
              
              core.setOutput('merged', String(result.data.merged));
              core.setOutput('sha', result.data.sha || '');
            } catch (e) {
              const msg = e?.message || String(e);
              core.setOutput('merged', 'false');
              core.setOutput('sha', '');
              core.setOutput('error', msg);
              core.setFailed(`Merge failed: ${msg}`);
            }

      - name: Clean up labels + comment
        if: success() && steps.merge.outputs.merged == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            // Remove the awaiting-merge label
            for (const name of ['gemini:awaiting-merge']) {
              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name });
              } catch (e) {}
            }

            // Comment on the PR
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: `üöÄ **Merged!** Changes have been integrated into the main branch.`
            });
            
            // Try to extract the original issue number from the PR body
            // PR body format: "Closes #123\n\nComment `/approve` ..."
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: issue_number });
            const prBody = pr.data.body || '';
            const issueMatch = prBody.match(/Closes #(\d+)/i);
            
            if (issueMatch) {
              const originalIssue = parseInt(issueMatch[1]);
              try {
                await github.rest.issues.createComment({
                  owner, repo,
                  issue_number: originalIssue,
                  body: `‚úÖ **Fixed!** PR #${issue_number} has been merged and this issue is now resolved.`
                });
              } catch (e) {
                console.log(`Could not comment on issue #${originalIssue}: ${e.message}`);
              }
            }

      - name: On merge failure, comment with diagnostics
        if: failure() && steps.merge.outcome == 'failure'
        uses: actions/github-script@v7
        env:
          MERGE_ERROR: ${{ steps.merge.outputs.error }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const err = (process.env.MERGE_ERROR || '').trim();

            const body =
              `‚ö†Ô∏è Merge failed for this PR.\n\n` +
              `Common causes:\n` +
              `- Branch protection rules require additional checks/reviews\n` +
              `- Merge conflicts exist\n` +
              `- PR is already merged or closed\n\n` +
              (err ? `Error details:\n\`\`\`\n${err.slice(0, 3000)}\n\`\`\`` : '');

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

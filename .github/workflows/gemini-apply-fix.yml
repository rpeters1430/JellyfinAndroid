name: Gemini Apply Fix (Issue -> PR)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-apply-fix-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  apply:
    if: |
      github.event.issue.pull_request == null &&
      (github.event.comment.body == '/approve' || github.event.comment.body == '@gemini-cli /approve')
    runs-on: ubuntu-latest

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Ensure issue is awaiting approval
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            if (!labels.includes('gemini:awaiting-approval')) {
              core.setFailed('Issue is not in gemini:awaiting-approval state.');
            }

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create branch name
        id: branch
        run: |
          echo "name=gemini/issue-${{ github.event.issue.number }}-fix-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Create and switch to branch
        run: git checkout -b "${{ steps.branch.outputs.name }}"

      - name: Run Gemini (generate unified diff patch)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          workflow_name: gemini-apply-fix
          upload_artifacts: true
          prompt: |
            Generate a unified diff patch to fix this issue.
            Output ONLY a unified diff starting with "diff --git".
            No markdown.

            Issue title: ${{ github.event.issue.title }}

            Issue body:
            ${{ github.event.issue.body }}

      - name: Write patch to file
        run: |
          cat > /tmp/gemini.patch << 'PATCH'
          ${{ steps.gemini.outputs.summary }}
          PATCH

      - name: Apply patch
        run: |
          git apply --whitespace=fix /tmp/gemini.patch
          git status --porcelain

      - name: Run tests (best effort)
        run: |
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew test || true
          else
            echo "No gradlew; skipping tests."
          fi

      - name: Commit changes
        run: |
          git config user.name "gemini-cli[bot]"
          git config user.email "gemini-cli[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Fix: #${{ github.event.issue.number }}"

      - name: Push branch
        run: git push --set-upstream origin "${{ steps.branch.outputs.name }}"

      - name: Create PR
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const head = "${{ steps.branch.outputs.name }}";
            const base = context.payload.repository.default_branch;

            const pr = await github.rest.pulls.create({
              owner, repo,
              title: `Fix: #${issue_number} (Gemini)`,
              head, base,
              body: `Closes #${issue_number}\n\nComment \`/approve\` on this PR to merge, or \`/deny\` to cancel.\n\n<!-- gemini-issue:${issue_number} -->`
            });

            core.setOutput('number', pr.data.number);
            core.setOutput('html_url', pr.data.html_url);

      - name: Update labels + comment back
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const pr_number = Number("${{ steps.pr.outputs.number }}");
            const prUrl = "${{ steps.pr.outputs.html_url }}";

            // Remove awaiting-approval from the issue
            try {
              await github.rest.issues.removeLabel({
                owner, repo,
                issue_number,
                name: 'gemini:awaiting-approval'
              });
            } catch (e) {}

            // Ensure PR label exists
            try {
              await github.rest.issues.createLabel({
                owner, repo,
                name: 'gemini:awaiting-merge',
                color: '0E8A16',
                description: 'Ready to merge when /approve is given on the PR'
              });
            } catch (e) {}

            // Apply label to PR (PRs are "issues" in this API)
            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: pr_number,
              labels: ['gemini:awaiting-merge']
            });

            // Comment back on the issue with PR link
            await github.rest.issues.createComment({
              owner, repo,
              issue_number,
              body: `âœ… Opened PR: ${prUrl}\n\nComment \`/approve\` on the PR to merge, or \`/deny\` to cancel.`
            });

            // Comment on the PR with instructions
            await github.rest.issues.createComment({
              owner, repo,
              issue_number: pr_number,
              body: `ðŸ¤– PR created for #${issue_number}.\n\nComment \`/approve\` to merge, or \`/deny\` to cancel.`
            });

# üîß Gemini Apply Fix Workflow
#
# Triggered by: Comment "/approve" on an issue with gemini:awaiting-approval label
# Generates code changes, creates a branch, and opens a PR with the fix.
# The PR will have "gemini:awaiting-merge" label for final approval.
#
# Documentation: .github/GEMINI_WORKFLOWS.md

name: Gemini Apply Fix (Issue -> PR)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-apply-fix-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  apply:
    if: |
      github.event.issue.pull_request == null &&
      (startsWith(github.event.comment.body, '/approve') || startsWith(github.event.comment.body, '@gemini-cli /approve'))
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Ensure issue is awaiting approval
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            if (!labels.includes('gemini:awaiting-approval')) {
              core.setFailed('Issue is not in gemini:awaiting-approval state.');
            }

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Snapshot repo context (file list)
        id: tree
        run: |
          set -euo pipefail
          echo "TREE<<EOF" >> "$GITHUB_OUTPUT"
          # Keep it short-ish but useful
          (git ls-files | head -n 400 || true) >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Load README.md into prompt context (if present)
        id: readme
        run: |
          set -euo pipefail
          if [ -f README.md ]; then
            echo "README_CONTENT<<EOF" >> "$GITHUB_OUTPUT"
            # Limit size to avoid huge prompts
            (head -n 200 README.md || true) >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "README_CONTENT=" >> "$GITHUB_OUTPUT"
          fi

      - name: Load CLAUDE.md into prompt context (if present)
        id: claude
        run: |
          set -euo pipefail
          if [ -f CLAUDE.md ]; then
            echo "CLAUDE_CONTENT<<EOF" >> "$GITHUB_OUTPUT"
            # Include more of CLAUDE.md since it has critical architecture info
            (head -n 300 CLAUDE.md || true) >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "CLAUDE_CONTENT=" >> "$GITHUB_OUTPUT"
          fi

      - name: Create branch name
        id: branch
        run: |
          echo "name=gemini/issue-${{ github.event.issue.number }}-fix-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Create and switch to branch
        run: git checkout -b "${{ steps.branch.outputs.name }}"

      - name: Run Gemini (generate unified diff patch)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          workflow_name: gemini-apply-fix
          upload_artifacts: true
          prompt: |
            You are a code patch generator for a GitHub repository.

            **CRITICAL REQUIREMENTS:**
            1. Output ONLY a valid unified diff format patch
            2. The FIRST line of output MUST start with: diff --git
            3. NO markdown code fences (no ```)
            4. NO explanatory text or commentary
            5. NO JSON or other formats

            **PATCH FORMAT EXAMPLE:**
            ```
            diff --git a/path/to/file.ext b/path/to/file.ext
            index abc123..def456 100644
            --- a/path/to/file.ext
            +++ b/path/to/file.ext
            @@ -10,7 +10,7 @@ context line
             context line
            -old line
            +new line
             context line
            ```

            **Your Task:**
            Fix the issue described below with minimal, targeted changes.
            - Prefer small, surgical edits
            - Include sufficient context in diffs (3+ lines)
            - Ensure file paths in diff headers are correct

            **Issue Title:** ${{ github.event.issue.title }}

            **Issue Body:**
            ${{ github.event.issue.body }}

            **Repository Context:**

            Available files (partial list):
            ---
            ${{ steps.tree.outputs.TREE }}
            ---

            Current README.md (first 200 lines):
            ---
            ${{ steps.readme.outputs.README_CONTENT }}
            ---

            Current CLAUDE.md (first 300 lines - IMPORTANT PROJECT ARCHITECTURE):
            ---
            ${{ steps.claude.outputs.CLAUDE_CONTENT }}
            ---

            **REMINDER:** Output ONLY the unified diff starting with "diff --git". No other text.

      - name: Extract diff into patch file
        id: patch
        env:
          GEMINI_OUTPUT: ${{ steps.gemini.outputs.summary }}
        run: |
          set -euo pipefail

          # Write the raw model output
          printf "%s\n" "${GEMINI_OUTPUT}" > /tmp/gemini_raw.txt

          # Extract from first "diff --git" onward (guards against any accidental preface)
          awk 'BEGIN{p=0} /^diff --git /{p=1} p{print}' /tmp/gemini_raw.txt > /tmp/gemini.patch

          if ! grep -q '^diff --git ' /tmp/gemini.patch; then
            echo "Gemini did not produce a valid unified diff. Raw output:"
            cat /tmp/gemini_raw.txt
            exit 1
          fi

          echo "Patch preview:"
          head -n 40 /tmp/gemini.patch

      - name: Apply patch (3-way)
        id: apply
        run: |
          set -euo pipefail

          # Try to apply the patch
          if ! git apply --check --whitespace=fix /tmp/gemini.patch 2>/tmp/apply_error.log; then
            echo "Patch check failed. Trying 3-way merge..."
            cat /tmp/apply_error.log
          fi

          # Apply with 3-way merge for better conflict resolution
          git apply --whitespace=fix --3way /tmp/gemini.patch

          # Show what changed
          echo "Changes applied:"
          git status --porcelain

          # Verify there are actual changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "WARNING: Patch applied but no changes detected"
            exit 1
          fi

      - name: Commit changes
        run: |
          set -euo pipefail
          git config user.name "gemini-cli[bot]"
          git config user.email "gemini-cli[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes staged; nothing to commit."
            exit 1
          fi
          git commit -m "Fix: #${{ github.event.issue.number }}"

      - name: Push branch
        run: |
          set -euo pipefail
          git push --set-upstream origin "${{ steps.branch.outputs.name }}"

      - name: Create PR
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const head = "${{ steps.branch.outputs.name }}";
            const base = context.payload.repository.default_branch;

            const pr = await github.rest.pulls.create({
              owner, repo,
              title: `Fix: #${issue_number} (Gemini)`,
              head, base,
              body: `Closes #${issue_number}\n\nComment \`/approve\` on this PR to merge.\n\n<!-- gemini-issue:${issue_number} -->`
            });

            core.setOutput('number', pr.data.number);
            core.setOutput('html_url', pr.data.html_url);

      - name: Update labels + comment back
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const pr_number = Number("${{ steps.pr.outputs.number }}");
            const prUrl = "${{ steps.pr.outputs.html_url }}";

            // Remove awaiting-approval from the issue (best effort)
            try {
              await github.rest.issues.removeLabel({
                owner, repo,
                issue_number,
                name: 'gemini:awaiting-approval'
              });
            } catch (e) {}

            // Apply awaiting-merge label to PR (PRs are "issues" in this API)
            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: pr_number,
              labels: ['gemini:awaiting-merge']
            });

            // Comment back on the issue with PR link
            await github.rest.issues.createComment({
              owner, repo,
              issue_number,
              body: `‚úÖ Opened PR: ${prUrl}\n\nComment \`/approve\` on the PR to merge.`
            });

            // Comment on the PR with instructions
            await github.rest.issues.createComment({
              owner, repo,
              issue_number: pr_number,
              body: `ü§ñ PR created for #${issue_number}.\n\nComment \`/approve\` to merge.`
            });

      - name: On failure, comment with diagnostics
        if: failure()
        uses: actions/github-script@v7
        env:
          GEMINI_ERROR: ${{ steps.gemini.outputs.error }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const err = (process.env.GEMINI_ERROR || '').trim();
            const body =
              `‚ö†Ô∏è Apply failed.\n\n` +
              `Common causes:\n` +
              `- Patch didn‚Äôt match repo files\n` +
              `- Patch wasn‚Äôt a valid unified diff\n` +
              `- No changes were produced\n\n` +
              (err ? `Gemini stderr/output:\n\`\`\`\n${err.slice(0, 3000)}\n\`\`\`\n` : '');

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

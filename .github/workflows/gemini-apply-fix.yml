name: Gemini Apply Fix (Issue -> PR)

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-apply-fix-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  apply:
    if: |
      github.event.issue.pull_request == null &&
      (github.event.comment.body == '/approve' || github.event.comment.body == '@gemini-cli /approve')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Ensure issue is awaiting approval
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || []).map(l => l.name);
            if (!labels.includes('gemini:awaiting-approval')) {
              core.setFailed('Issue is not in gemini:awaiting-approval state.');
            }

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Snapshot repo context (file list)
        id: tree
        run: |
          set -euo pipefail
          echo "TREE<<'EOF'" >> "$GITHUB_OUTPUT"
          # Keep it short-ish but useful
          (git ls-files | head -n 400) >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Load README.md into prompt context (if present)
        id: readme
        run: |
          set -euo pipefail
          if [ -f README.md ]; then
            echo "README_CONTENT<<'EOF'" >> "$GITHUB_OUTPUT"
            # Limit size to avoid huge prompts
            head -n 200 README.md >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "README_CONTENT=" >> "$GITHUB_OUTPUT"
          fi

      - name: Create branch name
        id: branch
        run: |
          echo "name=gemini/issue-${{ github.event.issue.number }}-fix-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Create and switch to branch
        run: git checkout -b "${{ steps.branch.outputs.name }}"

      - name: Run Gemini (generate unified diff patch)
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0.1.20
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: ${{ vars.GEMINI_MODEL }}
          workflow_name: gemini-apply-fix
          upload_artifacts: true
          prompt: |
            You are generating a patch for a GitHub repository.

            HARD REQUIREMENTS:
            - Output ONLY a unified diff.
            - The first diff line MUST start with: diff --git
            - No markdown fences, no commentary, no JSON.

            Goal:
            Fix the issue described below. Prefer minimal changes.

            Issue title: ${{ github.event.issue.title }}

            Issue body:
            ${{ github.event.issue.body }}

            Repo file list (partial):
            ---
            ${{ steps.tree.outputs.TREE }}
            ---

            Current README.md (first 200 lines, if present):
            ---
            ${{ steps.readme.outputs.README_CONTENT }}
            ---

            If your change touches README.md, ensure the patch matches the exact existing content above.

      - name: Extract diff into patch file
        id: patch
        run: |
          set -euo pipefail

          # Write the raw model output
          printf "%s\n" "${{ steps.gemini.outputs.gemini_response }}" > /tmp/gemini_raw.txt

          # Extract from first "diff --git" onward (guards against any accidental preface)
          awk 'BEGIN{p=0} /^diff --git /{p=1} p{print}' /tmp/gemini_raw.txt > /tmp/gemini.patch

          if ! grep -q '^diff --git ' /tmp/gemini.patch; then
            echo "Gemini did not produce a valid unified diff. Raw output:"
            cat /tmp/gemini_raw.txt
            exit 1
          fi

          echo "Patch preview:"
          head -n 40 /tmp/gemini.patch

      - name: Apply patch (3-way)
        run: |
          set -euo pipefail
          git apply --whitespace=fix --3way /tmp/gemini.patch
          git status --porcelain

      - name: Run tests (best effort)
        run: |
          set -euo pipefail
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew test || true
          else
            echo "No gradlew; skipping tests."
          fi

      - name: Commit changes
        run: |
          set -euo pipefail
          git config user.name "gemini-cli[bot]"
          git config user.email "gemini-cli[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes staged; nothing to commit."
            exit 1
          fi
          git commit -m "Fix: #${{ github.event.issue.number }}"

      - name: Push branch
        run: |
          set -euo pipefail
          git push --set-upstream origin "${{ steps.branch.outputs.name }}"

      - name: Create PR
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            const head = "${{ steps.branch.outputs.name }}";
            const base = context.payload.repository.default_branch;

            const pr = await github.rest.pulls.create({
              owner, repo,
              title: `Fix: #${issue_number} (Gemini)`,
              head, base,
              body: `Closes #${issue_number}\n\nComment \`/approve\` on this PR to merge, or \`/deny\` to cancel.\n\n<!-- gemini-issue:${issue_number} -->`
            });

            core.setOutput('number', pr.data.number);
            core.setOutput('html_url', pr.data.html_url);

      - name: Update labels + comment back
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const pr_number = Number("${{ steps.pr.outputs.number }}");
            const prUrl = "${{ steps.pr.outputs.html_url }}";

            // Remove awaiting-approval from the issue (best effort)
            try {
              await github.rest.issues.removeLabel({
                owner, repo,
                issue_number,
                name: 'gemini:awaiting-approval'
              });
            } catch (e) {}

            // Ensure PR label exists
            try {
              await github.rest.issues.createLabel({
                owner, repo,
                name: 'gemini:awaiting-merge',
                color: '0E8A16',
                description: 'Ready to merge when /approve is given on the PR'
              });
            } catch (e) {}

            // Apply label to PR (PRs are "issues" in this API)
            await github.rest.issues.addLabels({
              owner, repo,
              issue_number: pr_number,
              labels: ['gemini:awaiting-merge']
            });

            // Comment back on the issue with PR link
            await github.rest.issues.createComment({
              owner, repo,
              issue_number,
              body: `‚úÖ Opened PR: ${prUrl}\n\nComment \`/approve\` on the PR to merge, or \`/deny\` to cancel.`
            });

            // Comment on the PR with instructions
            await github.rest.issues.createComment({
              owner, repo,
              issue_number: pr_number,
              body: `ü§ñ PR created for #${issue_number}.\n\nComment \`/approve\` to merge, or \`/deny\` to cancel.`
            });

      - name: On failure, comment with diagnostics
        if: failure()
        uses: actions/github-script@v7
        env:
          GEMINI_ERRORS: ${{ steps.gemini.outputs.gemini_errors }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;

            const err = (process.env.GEMINI_ERRORS || '').trim();
            const body =
              `‚ö†Ô∏è Apply failed.\n\n` +
              `Common causes:\n` +
              `- Patch didn‚Äôt match repo files\n` +
              `- Patch wasn‚Äôt a valid unified diff\n` +
              `- No changes were produced\n\n` +
              (err ? `Gemini stderr/output:\n\`\`\`\n${err.slice(0, 3000)}\n\`\`\`\n` : '');

            await github.rest.issues.createComment({ owner, repo, issue_number, body });

# ğŸ›‘ Gemini Deny Workflow
#
# Triggered by: Comment "/deny" on an issue or PR
# Removes Gemini labels and closes the issue/PR as "not planned".
# Preserves any non-Gemini labels that were applied.
#
# Documentation: .github/GEMINI_WORKFLOWS.md

name: Gemini Deny (Cancel)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

concurrency:
  group: gemini-deny-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  deny:
    if: |
      github.event.comment.body == '/deny' || github.event.comment.body == '@gemini-cli /deny'
    runs-on: ubuntu-latest

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Remove Gemini labels + close
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = context.payload.issue.number;
            const isPr = !!context.payload.issue.pull_request;

            // Get current labels
            const currentLabels = (context.payload.issue.labels || []).map(l => l.name);
            
            // Remove only Gemini-related labels, keep other labels
            const geminiLabels = ['gemini:awaiting-approval', 'gemini:awaiting-merge'];
            const labelsToKeep = currentLabels.filter(l => !geminiLabels.includes(l));
            
            await github.rest.issues.setLabels({
              owner, repo,
              issue_number: number,
              labels: labelsToKeep
            });

            // Close the issue/PR
            await github.rest.issues.update({
              owner, repo,
              issue_number: number,
              state: 'closed',
              state_reason: isPr ? undefined : 'not_planned'
            });

            const message = isPr 
              ? 'ğŸ›‘ **Denied.** PR closed without merging. Gemini labels removed.' 
              : 'ğŸ›‘ **Denied.** Issue closed as not planned. Gemini labels removed.';

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: number,
              body: message
            });

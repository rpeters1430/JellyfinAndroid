name: Gemini Deny (Cancel)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

concurrency:
  group: gemini-deny-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  deny:
    if: |
      github.event.comment.body == '/deny' || github.event.comment.body == '@gemini-cli /deny'
    runs-on: ubuntu-latest

    steps:
      - name: Permission gate
        uses: actions/github-script@v7
        with:
          script: |
            const assoc = context.payload.comment.author_association;
            const allowed = ['OWNER','MEMBER','COLLABORATOR'];
            if (!allowed.includes(assoc)) {
              core.setFailed(`Not allowed: author_association=${assoc}`);
            }

      - name: Remove all labels + close
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = context.payload.issue.number;
            const isPr = !!context.payload.issue.pull_request;

            // Remove ALL labels (this is your "remove tags" requirement)
            await github.rest.issues.setLabels({
              owner, repo,
              issue_number: number,
              labels: []
            });

            // Close (GitHub does not support "delete issue" via API)
            await github.rest.issues.update({
              owner, repo,
              issue_number: number,
              state: 'closed'
            });

            // Optional: lock conversation to reduce noise
            // try {
            //   await github.rest.issues.lock({ owner, repo, issue_number: number, lock_reason: 'resolved' });
            // } catch (e) {}

            await github.rest.issues.createComment({
              owner, repo,
              issue_number: number,
              body: isPr ? 'ðŸ›‘ Denied. Labels removed and PR closed (not merged).' : 'ðŸ›‘ Denied. Labels removed and issue closed.'
            });
